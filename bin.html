<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Twitch Bottle Battle Royale</title>
    <style>
        body { margin: 0; overflow: hidden; background: #111; font-family: 'Courier New', Courier, monospace; }
        #stage { width: 100vw; height: 100vh; position: relative; }

        /* キャラクター */
        .char-container { position: absolute; width: 40px; height: 40px; z-index: 10; }
        .pixel-body { width: 40px; height: 40px; display: grid; grid-template-columns: repeat(5, 8px); }
        .px { width: 8px; height: 8px; }
        .user-name { position: absolute; top: 45px; width: 120px; left: -40px; text-align: center; color: white; font-size: 12px; text-shadow: 2px 2px 0px #000; background: rgba(0,0,0,0.4); border-radius: 4px; pointer-events: none; }

        /* ビン（ドット絵風） */
        .bottle { position: absolute; width: 14px; height: 18px; background: #00f2ff; border: 2px solid #fff; border-radius: 2px; z-index: 15; box-shadow: 0 0 10px #00f2ff; }
        .bottle::before { content: ''; position: absolute; top: -4px; left: 3px; width: 8px; height: 4px; background: #ddd; }

        /* 陣地 */
        .home-mark { position: absolute; width: 60px; height: 60px; border: 2px dashed #444; border-radius: 50%; transform: translate(-10px, -10px); z-index: 5; }
        .home-label { position: absolute; top: -20px; width: 100%; text-align: center; color: #00ff00; font-weight: bold; font-size: 14px; }

        /* 勝利画面（黒背景・緑ふち） */
        #win-screen {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #000; border: 4px solid #00ff00; color: #00ff00; padding: 40px 60px;
            font-size: 32px; font-weight: bold; z-index: 2000; text-align: center;
            box-shadow: 0 0 50px rgba(0, 255, 0, 0.7);
        }
    </style>
</head>
<body>
    <div id="win-screen">勝者：<span id="winner-name"></span></div>
    <div id="stage"></div>

    <script src="https://cdn.jsdelivr.net/npm/comfy.js@latest/dist/comfy.min.js"></script>
    <script>
        const stage = document.getElementById('stage');
        const winScreen = document.getElementById('win-screen');
        const winnerName = document.getElementById('winner-name');
        
        // 設定値
        const RADIUS = 200; 
        const SPEED = 15 / 60; // 15px per second
        
        let centerX = window.innerWidth / 2;
        let centerY = window.innerHeight / 2;
        let players = [];
        let slotAngles = [ -Math.PI/2, Math.PI/6, 5*Math.PI/6 ]; // 最初の3人の角度

        // リサイズ対応
        window.addEventListener('resize', () => {
            centerX = window.innerWidth / 2;
            centerY = window.innerHeight / 2;
        });

        // ComfyJS 初期化
        const params = new URLSearchParams(window.location.search);
        if (params.get('channel')) ComfyJS.Init(params.get('channel'));

        ComfyJS.onCommand = (user, command, message, flags, extra) => {
            const cmd = command.toLowerCase();
            
            // 参加処理
            if (cmd === "join") {
                addPlayer(user);
                return;
            }

            // 指令処理
            const player = players.find(p => p.name.toLowerCase() === user.toLowerCase());
            if (!player) return;

            if (!isNaN(cmd)) {
                const targetIdx = parseInt(cmd) - 1;
                const targetPlayer = players[targetIdx];
                // ビンがある陣地のみ狙える
                if (targetPlayer && targetIdx !== player.index && targetPlayer.bottlesAtHome > 0) {
                    player.target = targetPlayer;
                    player.state = 'hunting';
                }
            }
        };

        function addPlayer(name) {
            if (players.find(p => p.name.toLowerCase() === name.toLowerCase())) return;
            
            // 4人目以降のスロット拡張
            while (players.length >= slotAngles.length) {
                expandSlots();
            }

            const angle = slotAngles[players.length];
            const px = centerX + RADIUS * Math.cos(angle) - 20;
            const py = centerY + RADIUS * Math.sin(angle) - 20;

            const p = {
                name: name,
                index: players.length,
                x: px, y: py,
                homeX: px, homeY: py,
                bottlesAtHome: 1,
                hasBottle: false,
                state: 'idle',
                target: null,
                color: `hsl(${Math.random() * 360}, 80%, 60%)`,
                el: null, homeBottleEl: null, carrierBottleEl: null
            };

            players.push(p);
            renderPlayer(p);
        }

        function expandSlots() {
            let newSlots = [];
            for (let i = 0; i < slotAngles.length; i++) {
                let current = slotAngles[i];
                let next = slotAngles[(i + 1) % slotAngles.length];
                let diff = next - current;
                if (diff <= 0) diff += Math.PI * 2;
                newSlots.push(current);
                newSlots.push(current + diff / 2);
            }
            slotAngles = newSlots;
        }

        function renderPlayer(p) {
            // 陣地マーク
            const home = document.createElement('div');
            home.className = 'home-mark';
            home.style.left = p.homeX + "px";
            home.style.top = p.homeY + "px";
            home.innerHTML = `<div class="home-label">!${p.index + 1}</div>`;
            stage.appendChild(home);

            // キャラ本体
            const container = document.createElement('div');
            container.className = 'char-container';
            const body = document.createElement('div');
            body.className = 'pixel-body';
            // 簡易ドットキャラ生成
            const pattern = [6,7,8,11,12,13,16,17,18,21,23];
            for(let i=0; i<25; i++) {
                const pix = document.createElement('div');
                pix.className = 'px';
                pix.style.backgroundColor = pattern.includes(i) ? p.color : 'transparent';
                body.appendChild(pix);
            }
            
            // 運搬用ビン
            const carrier = document.createElement('div');
            carrier.className = 'bottle';
            carrier.style.display = 'none';
            carrier.style.top = '-25px';
            carrier.style.left = '13px';
            
            const nameTag = document.createElement('div');
            nameTag.className = 'user-name';
            nameTag.innerText = p.name;

            container.appendChild(carrier);
            container.appendChild(body);
            container.appendChild(nameTag);
            stage.appendChild(container);
            p.el = container;
            p.carrierBottleEl = carrier;

            // 陣地ビン
            const hb = document.createElement('div');
            hb.className = 'bottle';
            stage.appendChild(hb);
            p.homeBottleEl = hb;
        }

        function loop() {
            players.forEach(p => {
                if (p.state !== 'idle') {
                    let tx = p.homeX;
                    let ty = p.homeY;

                    if (p.state === 'hunting' && p.target) {
                        tx = p.target.homeX;
                        ty = p.target.homeY;
                        // 向かっている間にビンがなくなったら引き返す
                        if (p.target.bottlesAtHome <= 0) {
                            p.state = 'returning';
                            p.target = null;
                        } else if (getDist(p.x, p.y, tx, ty) < 5) {
                            // 奪取成功
                            p.target.bottlesAtHome--;
                            p.hasBottle = true;
                            p.state = 'returning';
                        }
                    } else if (p.state === 'returning') {
                        if (getDist(p.x, p.y, p.homeX, p.homeY) < 5) {
                            // 帰還完了
                            if (p.hasBottle) {
                                p.bottlesAtHome++;
                                p.hasBottle = false;
                                if (p.bottlesAtHome >= 2) announceWinner(p);
                            }
                            p.state = 'idle';
                        }
                    }
                    move(p, tx, ty);
                }

                // 表示反映
                p.el.style.left = p.x + "px";
                p.el.style.top = p.y + "px";
                p.homeBottleEl.style.display = p.bottlesAtHome > 0 ? 'block' : 'none';
                p.homeBottleEl.style.left = (p.homeX + 13) + "px";
                p.homeBottleEl.style.top = (p.homeY + 10) + "px";
                p.carrierBottleEl.style.display = p.hasBottle ? 'block' : 'none';
            });
            requestAnimationFrame(loop);
        }

        function move(p, tx, ty) {
            const dx = tx - p.x;
            const dy = ty - p.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if (dist > 0) {
                p.x += (dx / dist) * SPEED;
                p.y += (dy / dist) * SPEED;
            }
        }

        function getDist(x1, y1, x2, y2) {
            return Math.sqrt((x2-x1)**2 + (y2-y1)**2);
        }

        function announceWinner(p) {
            winnerName.innerText = p.name;
            winScreen.style.display = 'block';
            setTimeout(() => { location.reload(); }, 7000);
        }

        loop();
    </script>
</body>
</html>
