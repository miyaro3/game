<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Twitch Animal Chat Park - Master Full Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background: transparent; font-family: 'Arial', sans-serif; cursor: pointer; }
        #stage { width: 100vw; height: 100vh; position: relative; }

        .char-container {
            position: absolute; width: 50px; height: 50px;
            display: flex; flex-direction: column; align-items: center; z-index: 10;
            transition: opacity 1s;
        }

        .bubble {
            background: white; color: black; border-radius: 12px; padding: 6px 12px;
            font-size: 14px; font-weight: bold; position: absolute; bottom: 75px;
            white-space: nowrap; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            opacity: 0; pointer-events: none; transition: opacity 0.2s; z-index: 100;
        }
        .bubble.show { opacity: 1; }

        .pixel-grid { display: grid; grid-template-columns: repeat(10, 5px); grid-template-rows: repeat(10, 5px); }
        .px { width: 5px; height: 5px; }
        .user-name { font-size: 12px; color: white; text-shadow: 2px 2px 2px black; background: rgba(0,0,0,0.5); border-radius: 4px; padding: 2px 5px; margin-top: 4px; }

        /* „ÅîÈ£Ø„ÅÆË¶ã„ÅüÁõÆ */
        .food {
            position: absolute; width: 10px; height: 10px;
            display: grid; grid-template-columns: 5px 5px; grid-template-rows: 5px 5px;
            z-index: 5; pointer-events: none;
        }
        .food-dot { width: 5px; height: 5px; background: yellow; border: 0.5px solid #cc0; box-sizing: border-box; }

        .fireball { position: absolute; font-size: 30px; z-index: 50; pointer-events: none; line-height: 1; }
        #clean-bar {
            position: absolute; width: 40px; height: 100vh; background: linear-gradient(to right, #444, #eee, #444);
            top: 0; left: -100px; z-index: 1000; box-shadow: 0 0 30px rgba(255,255,255,0.6);
            display: none;
        }

        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        .anim-shake { animation: shake 0.1s linear infinite; }
        @keyframes shake { 0% { transform: translateX(-5px); } 100% { transform: translateX(5px); } }
        .anim-dance { animation: dance 0.4s ease-out infinite; }
        @keyframes dance { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-30px); } }
        .anim-bomb { animation: bomb 0.6s forwards; }
        @keyframes bomb { 0% { transform: scale(1); } 50% { transform: scale(4); opacity: 0.8; background: orange; border-radius: 50%; } 100% { transform: scale(0); opacity: 0; } }
    </style>
</head>
<body>
    <div id="clean-bar"></div>
    <div id="stage"></div>

    <script src="https://cdn.jsdelivr.net/npm/comfy.js@latest/dist/comfy.min.js"></script>
    <script>
        const STAGE_WIDTH = window.innerWidth;
        const STAGE_HEIGHT = window.innerHeight;
        const CHAR_SIZE = 50;
        
        let globalLifetimeMs = 15 * 60 * 1000; // „Éá„Éï„Ç©„É´„Éà15ÂàÜ
        let users = {};
        let fireballs = [];
        let foods = [];
        let cleanBar = { x: -100, active: false, speed: 10 };
        let testUserCount = 0;

        const SHAPES = [
            ["0100000010","1110000111","1111111111","1121111211","1111331111","1111111111","0111111110","0011111100","0011001100","0000000000"],
            ["0011001100","0111111110","1111111111","1121111211","1113333111","1111111111","0111111110","0011111100","0011001100","0000000000"],
            ["0110000110","1111001111","1111111111","1121111211","1111111111","1111111111","0111111110","0111111110","0110000110","0000000000"],
            ["0100000010","0100000010","0111001110","1111111111","1121111211","1111331111","1111111111","0111111110","0011111100","0011001100","0000000000"]
        ];

        const params = new URLSearchParams(window.location.search);
        const channel = params.get('channel');
        if (channel) ComfyJS.Init(channel);

        ComfyJS.onCommand = (user, command, message, flags, extra) => {
            const userId = user.toLowerCase();
            
            // ÈÖç‰ø°ËÄÖÁî®ÔºöÂØøÂëΩË®≠ÂÆö„Ç≥„Éû„É≥„Éâ
            if (command === "life" && (flags.broadcaster || flags.mod)) {
                const mins = parseInt(message.trim());
                if (!isNaN(mins)) {
                    globalLifetimeMs = mins * 60 * 1000;
                    Object.keys(users).forEach(id => resetLifetime(users[id], id));
                }
                return;
            }

            if (!users[userId]) spawnUser(user);
            resetLifetime(users[userId], userId);
            handleAction(users[userId], "!" + command, message, userId);
        };

        ComfyJS.onChat = (user, message) => {
            const userId = user.toLowerCase();
            if (!users[userId]) spawnUser(user);
            resetLifetime(users[userId], userId);
            if (message.startsWith("!")) return;
            showBubble(users[userId], message);
        };

        document.body.addEventListener('click', (e) => {
            const idStr = testUserCount.toString().padStart(2, '0');
            const name = "Test_" + idStr;
            spawnUser(name, e.clientX-25, e.clientY-25);
            resetLifetime(users[name.toLowerCase()], name.toLowerCase());
            testUserCount++;
        });

        function spawnUser(userName, x, y) {
            const container = document.createElement('div');
            container.className = 'char-container';
            const shapeIdx = Math.floor(Math.random() * SHAPES.length);
            const mainColor = `hsl(${Math.random() * 360}, 80%, 70%)`;
            const grid = document.createElement('div');
            grid.className = 'pixel-grid';
            const shapeData = SHAPES[shapeIdx].join("");
            for (let i = 0; i < 100; i++) {
                const px = document.createElement('div');
                px.className = 'px';
                if (shapeData[i] === "1") px.style.backgroundColor = mainColor;
                else if (shapeData[i] === "2") px.style.backgroundColor = "black";
                else if (shapeData[i] === "3") px.style.backgroundColor = "#ffb7c5";
                grid.appendChild(px);
            }
            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            const nameTag = document.createElement('div');
            nameTag.className = 'user-name';
            nameTag.innerText = userName;

            container.appendChild(bubble);
            container.appendChild(grid);
            container.appendChild(nameTag);
            document.getElementById('stage').appendChild(container);

            users[userName.toLowerCase()] = {
                el: container, inner: grid, bubble: bubble,
                x: x || Math.random() * (STAGE_WIDTH - CHAR_SIZE),
                y: y || Math.random() * (STAGE_HEIGHT - CHAR_SIZE),
                vx: 0, vy: 0, dir: 1, state: 'idle', stateTimer: 50, 
                busy: false, falling: false, targetX: null, targetY: null,
                dieTimer: null
            };
        }

        function resetLifetime(u, userId) {
            if (u.dieTimer) clearTimeout(u.dieTimer);
            u.el.style.opacity = '1';
            if (globalLifetimeMs <= 0) return; // 0ÂàÜÊåáÂÆö„Å™„ÇâÊ∂à„Åà„Å™„ÅÑ
            u.dieTimer = setTimeout(() => {
                if (u.el) {
                    u.el.style.opacity = '0';
                    setTimeout(() => { if (u.el) u.el.remove(); delete users[userId]; }, 1000);
                }
            }, globalLifetimeMs);
        }

        function spawnFood(x, y, ownerId) {
            const foodEl = document.createElement('div');
            foodEl.className = 'food';
            for(let i=0; i<4; i++) {
                const dot = document.createElement('div');
                dot.className = 'food-dot';
                foodEl.appendChild(dot);
            }
            foodEl.style.left = x + "px"; foodEl.style.top = y + "px";
            document.getElementById('stage').appendChild(foodEl);
            foods.push({ el: foodEl, x: x, y: y, owner: ownerId });
        }

        function handleAction(u, cmd, message, userId) {
            u.inner.classList.remove('anim-shake', 'anim-dance');
            u.targetX = null; u.targetY = null;

            if (cmd === "!up") { u.vy = -20; u.falling = false; u.busy = false; }
            else if (cmd === "!down") { u.vy = 20; u.falling = false; u.busy = false; }
            else if (cmd === "!left") { u.vx = -20; u.dir = -1; u.falling = false; u.busy = false; }
            else if (cmd === "!right") { u.vx = 20; u.dir = 1; u.falling = false; u.busy = false; }
            else if (cmd === "!shake") { u.inner.classList.add('anim-shake'); setTimeout(()=>u.inner.classList.remove('anim-shake'), 2000); }
            else if (cmd === "!dance") { u.inner.classList.add('anim-dance'); setTimeout(()=>u.inner.classList.remove('anim-dance'), 3000); }
            
            else if (cmd === "!feed") {
                const targetName = message.trim().toLowerCase();
                const target = users[targetName];
                if (target && target !== u) {
                    u.busy = true;
                    const goFeed = () => {
                        const dx = target.x - u.x; const dy = target.y - u.y;
                        const dist = Math.sqrt(dx*dx + dy*dy);
                        if (dist > 40 && u.busy) {
                            u.vx = (dx / dist) * 4; u.vy = (dy / dist) * 4;
                            requestAnimationFrame(goFeed);
                        } else {
                            u.busy = false; spawnFood(target.x + 20, target.y + 40, userId);
                        }
                    };
                    goFeed();
                } else {
                    spawnFood(u.x + 20, u.y + 40, userId);
                }
            }

            else if (cmd === "!set") {
                const userList = Object.values(users);
                const spacing = STAGE_WIDTH / (userList.length + 1);
                userList.forEach((char, index) => {
                    char.busy = true; char.falling = false;
                    char.targetX = spacing * (index + 1) - (CHAR_SIZE / 2);
                    char.targetY = STAGE_HEIGHT - CHAR_SIZE - 20;
                    if(char.setTimer) clearTimeout(char.setTimer);
                    char.setTimer = setTimeout(() => { char.busy = false; char.targetX = null; char.targetY = null; }, 5000);
                });
            }
            else if (cmd === "!bomb") {
                u.inner.classList.add('anim-bomb');
                Object.values(users).forEach(target => {
                    if (target === u) return;
                    const dx = target.x - u.x; const dy = target.y - u.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < 250) {
                        const power = (250 - dist) / 10;
                        target.vx = (dx / dist) * power * 2; target.vy = (dy / dist) * power * 2;
                        target.busy = false;
                    }
                });
                setTimeout(() => { if(u.el) u.el.remove(); delete users[userId]; }, 600);
            }
            else if (cmd === "!battle") {
                const targetName = message.trim().toLowerCase();
                const target = users[targetName];
                if (target) {
                    u.busy = true;
                    const battleMove = () => {
                        const dx = target.x - u.x; const dy = target.y - u.y;
                        const dist = Math.sqrt(dx*dx + dy*dy);
                        if (dist > 10 && u.busy) {
                            u.vx = (dx / dist) * 15; u.vy = (dy / dist) * 15;
                            requestAnimationFrame(battleMove);
                        } else { u.busy = false; }
                    };
                    battleMove();
                }
            }
            else if (cmd === "!clean") { cleanBar.active = true; cleanBar.x = -100; document.getElementById('clean-bar').style.display = 'block'; }
            else if (cmd === "!fire") {
                let vxf, vyf;
                const targetName = message.trim().toLowerCase();
                const target = users[targetName];
                if (target && target !== u) {
                    const dx = target.x - u.x; const dy = target.y - u.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    vxf = (dx / dist) * 12; vyf = (dy / dist) * 12;
                } else {
                    const angle = Math.random() * Math.PI * 2;
                    vxf = Math.cos(angle) * 12; vyf = Math.sin(angle) * 12;
                }
                const fb = document.createElement('div');
                fb.className = 'fireball'; fb.innerText = "üî•";
                document.getElementById('stage').appendChild(fb);
                fireballs.push({ el: fb, x: u.x + (vxf * 4), y: u.y + (vyf * 4), vx: vxf, vy: vyf, life: 180, owner: u });
            }
            else if (cmd === "!fall") {
                Object.values(users).forEach(target => {
                    target.vy = 25; target.falling = true; target.busy = false;
                    target.targetX = null; target.targetY = null;
                });
            }
        }

        function showBubble(u, text) {
            u.bubble.innerText = text; u.bubble.classList.add('show');
            setTimeout(() => u.bubble.classList.remove('show'), 5000);
        }

        function loop() {
            if (cleanBar.active) {
                cleanBar.x += cleanBar.speed;
                const barEl = document.getElementById('clean-bar');
                barEl.style.left = cleanBar.x + "px";
                if (cleanBar.x > STAGE_WIDTH) { cleanBar.active = false; barEl.style.display = 'none'; }
            }

            fireballs = fireballs.filter(fb => {
                fb.x += fb.vx; fb.y += fb.vy;
                fb.el.style.left = fb.x + "px"; fb.el.style.top = fb.y + "px";
                fb.life--;
                Object.values(users).forEach(u => {
                    if (u === fb.owner) return;
                    const dx = u.x - fb.x; const dy = u.y - fb.y;
                    if (Math.sqrt(dx*dx + dy*dy) < 40) {
                        u.vx = fb.vx * 1.5; u.vy = fb.vy * 1.5 - 5; fb.life = 0; u.busy = false;
                    }
                });
                if (fb.life <= 0) fb.el.remove();
                return fb.life > 0;
            });

            const list = Object.entries(users);
            list.forEach(([userId, u], i) => {
                if (cleanBar.active && u.x < cleanBar.x + 40) { u.x = cleanBar.x + 40; u.vx = cleanBar.speed; u.busy = false; }
                
                // „ÅîÈ£ØÊé¢Áü•„ÉªÈ£ü‰∫ã„É≠„Ç∏„ÉÉ„ÇØ
                if (!u.busy) {
                    let nearestFood = null;
                    let minDist = 150;
                    foods.forEach(f => {
                        if (f.owner === userId) return; // Ëá™ÂàÜ„ÅÆÁΩÆ„ÅÑ„Åü„ÅîÈ£Ø„ÅØÈ£ü„Åπ„Å™„ÅÑ
                        const dx = f.x - u.x; const dy = f.y - u.y;
                        const dist = Math.sqrt(dx*dx + dy*dy);
                        if (dist < minDist) { minDist = dist; nearestFood = f; }
                    });

                    if (nearestFood) {
                        const dx = nearestFood.x - u.x; const dy = nearestFood.y - u.y;
                        if (minDist > 10) {
                            u.vx += (dx / minDist) * 0.5; u.vy += (dy / minDist) * 0.5;
                        } else {
                            nearestFood.el.remove();
                            foods = foods.filter(f => f !== nearestFood);
                            u.inner.classList.add('anim-dance');
                            setTimeout(() => u.inner.classList.remove('anim-dance'), 2000);
                            resetLifetime(u, userId);
                        }
                    }
                }

                if (u.busy && u.targetX !== null) {
                    const dx = u.targetX - u.x; const dy = u.targetY - u.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist > 2) { u.vx = dx * 0.1; u.vy = dy * 0.1; } 
                    else { u.x = u.targetX; u.y = u.targetY; u.vx = 0; u.vy = 0; }
                } else if (!u.busy && !u.falling) {
                    u.stateTimer--;
                    if (u.stateTimer <= 0) {
                        u.state = (u.state === 'idle') ? 'walk' : 'idle';
                        u.stateTimer = 60 + Math.random() * 100;
                        if (u.state === 'walk') { u.vx = (Math.random()-0.5)*3; u.vy = (Math.random()-0.5)*3; }
                    }
                }
                u.x += u.vx; u.y += u.vy;
                if (!u.busy) { u.vx *= 0.96; u.vy *= 0.96; }
                if (u.x < 0) { u.x = 0; u.vx *= -1; }
                if (u.x > STAGE_WIDTH - CHAR_SIZE) { u.x = STAGE_WIDTH - CHAR_SIZE; u.vx *= -1; }
                if (u.y < 0) { u.y = 0; u.vy *= -1; }
                if (u.y > STAGE_HEIGHT - CHAR_SIZE) { u.y = STAGE_HEIGHT - CHAR_SIZE; u.vy *= -0.4; u.falling = false; }

                for (let j = i + 1; j < list.length; j++) {
                    const o = list[j][1];
                    const dx = o.x - u.x; const dy = o.y - u.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < CHAR_SIZE) {
                        const angle = Math.atan2(dy, dx);
                        const push = (CHAR_SIZE - dist) * 0.2;
                        let bounce = 1.0;
                        if (u.busy || o.busy) { if(u.targetX === null) { bounce = Math.random() > 0.5 ? 4.0 : -2.0; u.busy = false; o.busy = false; } }
                        u.vx -= Math.cos(angle) * push * bounce; u.vy -= Math.sin(angle) * push * bounce;
                        o.vx += Math.cos(angle) * push * bounce; o.vy += Math.sin(angle) * push * bounce;
                    }
                }
                u.el.style.left = u.x + "px"; u.el.style.top = u.y + "px";
            });
            requestAnimationFrame(loop);
        }
        loop();
    </script>
</body>
</html>