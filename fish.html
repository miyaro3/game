<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Twitch Fishing Game - Procedural Fish</title>
    <script src="https://cdn.jsdelivr.net/npm/comfy.js@latest/dist/comfy.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: transparent; font-family: 'Helvetica Neue', Arial, sans-serif; }
        #game-container { position: relative; width: 100vw; height: 100vh; }
        #canvas { width: 100%; height: 100%; image-rendering: pixelated; }
        
        #result-ui {
            position: absolute; 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%);
            text-align: center; color: white;
            display: none; pointer-events: none;
            min-width: 450px;
            padding: 40px;
            background: rgba(0, 0, 0, 0.85);
            border-radius: 30px;
            z-index: 50;
            transition: all 0.5s ease;
        }

        #res-fish { font-size: 4.5rem; margin: 20px 0; font-weight: bold; }
        
        /* „É¨„Ç¢Â∫¶Âà•„Çπ„Çø„Ç§„É´ÔºàJS„ÅßÂãïÁöÑ„Å´„ÇØ„É©„Çπ„Çí‰ªò„ÅëÊõø„ÅàÔºâ */
        .rarity-border-1 { border: 4px solid #888; box-shadow: 0 0 20px rgba(136,136,136,0.5); }
        .rarity-border-2 { border: 4px solid #4a4; box-shadow: 0 0 20px rgba(68,255,68,0.5); }
        .rarity-border-3 { border: 4px solid #44f; box-shadow: 0 0 25px rgba(68,68,255,0.6); }
        .rarity-border-4 { border: 4px solid #ea0; box-shadow: 0 0 35px rgba(238,170,0,0.7); }
        .rarity-border-5 { border: 4px solid #f0f; box-shadow: 0 0 50px rgba(255,0,255,0.8); animation: glow-pulse 1s infinite alternate; }

        @keyframes glow-pulse { from { transform: translate(-50%, -50%) scale(1); } to { transform: translate(-50%, -50%) scale(1.02); } }

        #ranking {
            position: absolute; bottom: -100%; left: 50%; transform: translateX(-50%);
            width: 350px; color: gold; text-align: center;
            background: rgba(0,0,0,0.9); padding: 30px; border-radius: 20px;
            border: 2px solid gold; transition: bottom 12s linear; z-index: 100;
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="canvas"></canvas>
    <div id="result-ui">
        <div id="res-user" style="font-size: 1.5rem; opacity: 0.8;"></div>
        <div id="res-fish"></div>
        <div id="res-detail" style="font-size: 1.8rem;"></div>
    </div>
    <div id="ranking"></div>
</div>

<script>
    const params = new URLSearchParams(window.location.search);
    const channel = params.get('channel');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let fishData = [];
    let queue = [];
    let isPlaying = false;
    let scores = JSON.parse(localStorage.getItem('fishScores') || '{}');

    // „Éë„Éº„ÉÑÁµÑ„ÅøÂêà„Çè„ÅõÊèèÁîªÈñ¢Êï∞
    function drawProceduralObject(ctx, x, y, size, hue, fishId, category) {
        const p = size / 16;
        ctx.fillStyle = `hsl(${hue}, 60%, 50%)`;

        if (category === "trash" || category === "treasure") {
            // „Ç¥„Éü„Éª„ÅäÂÆù„ÅØ„ÄåÁÆ±Âûã„Äç
            ctx.fillRect(x + 3*p, y + 4*p, 10*p, 8*p);
            ctx.fillStyle = `hsl(${hue}, 60%, 30%)`;
            ctx.fillRect(x + 4*p, y + 5*p, 2*p, 2*p); // Ê®°Êßò
        } else {
            // È≠öÔºöID„Å´Âü∫„Å•„ÅÑ„Å¶„Éë„Éº„ÉÑ„ÇíÊ±∫ÂÆö
            const bodyType = fishId % 3;
            const eyeType = (fishId >> 1) % 3;
            const tailType = (fishId >> 2) % 3;

            // 1. Â∞æ„Å≥„Çå
            ctx.fillStyle = `hsl(${hue}, 60%, 40%)`;
            if (tailType === 0) { // ‰∏âËßí
                ctx.fillRect(x + 1*p, y + 4*p, 3*p, 8*p);
            } else if (tailType === 1) { // ‰∫åËÇ°
                ctx.fillRect(x + 1*p, y + 3*p, 2*p, 3*p);
                ctx.fillRect(x + 1*p, y + 10*p, 2*p, 3*p);
            } else { // ‰∏∏
                ctx.fillRect(x + 2*p, y + 5*p, 2*p, 6*p);
            }

            // 2. ‰Ωì
            ctx.fillStyle = `hsl(${hue}, 60%, 50%)`;
            if (bodyType === 0) { // Ê®ôÊ∫ñ
                ctx.fillRect(x + 4*p, y + 5*p, 9*p, 6*p);
            } else if (bodyType === 1) { // Á¥∞Èï∑„ÅÑ
                ctx.fillRect(x + 4*p, y + 7*p, 11*p, 3*p);
            } else { // „Åæ„Çì„Åæ„Çã
                ctx.fillRect(x + 5*p, y + 3*p, 7*p, 10*p);
            }

            // 3. ÁõÆ
            ctx.fillStyle = 'white';
            const eyeX = (bodyType === 1) ? 12 : 10;
            if (eyeType === 0) ctx.fillRect(x + eyeX*p, y + 6*p, 2*p, 2*p); // ÊôÆÈÄö
            else if (eyeType === 1) ctx.fillRect(x + eyeX*p, y + 5*p, 1*p, 1*p); // Â∞è„Åï„ÅÑ
            else { // Á∏¶Èï∑
                ctx.fillRect(x + eyeX*p, y + 6*p, 2*p, 3*p);
                ctx.fillStyle = 'black';
                ctx.fillRect(x + (eyeX+1)*p, y + 7*p, 1*p, 1*p);
            }
        }
    }

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    fetch('fish_data.json').then(res => res.json()).then(data => { fishData = data; });

    if (channel) {
        ComfyJS.onCommand = (user, command) => {
            if (command === "fish") {
                if (!queue.some(q => q.user === user)) {
                    queue.push({ user });
                    if (!isPlaying) processQueue();
                }
            }
            if (command === "score") showRanking();
        };
        ComfyJS.Init(channel);
    }

    function processQueue() {
        if (isPlaying || queue.length === 0) return;
        isPlaying = true;
        startFishingAnimation(queue.shift().user);
    }

    function startFishingAnimation(username) {
        const fish = fishData[Math.floor(Math.random() * fishData.length)];
        const finalSize = (fish.base_size_cm * (0.8 + Math.random() * 0.6)).toFixed(1);
        const fishHue = Math.floor(Math.random() * 360);
        scores[username] = (scores[username] || 0) + Math.floor(fish.rarity * finalSize);
        localStorage.setItem('fishScores', JSON.stringify(scores));

        let frame = 0;
        const p1 = 50, p2 = 130, p3 = 180, total = 380;

        function frameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            frame++;
            let hookY;
            const isCaught = frame >= p1;
            
            if (frame < p1) hookY = (frame / p1) * (canvas.height * 0.6);
            else if (frame < p2) hookY = (canvas.height * 0.6) - (frame - p1) * 5;
            else if (frame < p3) hookY = (canvas.height * 0.6) - (p2 - p1) * 5 + ((canvas.height/2) - ((canvas.height * 0.6) - (p2 - p1) * 5)) * ((frame - p2)/(p3 - p2));
            else hookY = canvas.height / 2 + Math.sin(frame * 0.05) * 5;

            if (frame < p3) {
                ctx.strokeStyle = "white"; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.moveTo(canvas.width/2, 0); ctx.lineTo(canvas.width/2, hookY); ctx.stroke();
            }

            if (isCaught) {
                const dSize = 40 * (fish.base_size_cm / 50 + 0.5) * (frame > p2 ? 1.5 : 1);
                drawProceduralObject(ctx, canvas.width/2 - dSize/2, hookY - dSize/2, dSize, fishHue, fish.id, fish.category);
            }

            if (frame === p3) showResultUI(username, fish, finalSize);
            if (frame < total) requestAnimationFrame(frameLoop);
            else { hideResultUI(); }
        }
        frameLoop();
    }

    function showResultUI(user, fish, size) {
        const ui = document.getElementById('result-ui');
        ui.className = `rarity-border-${fish.rarity}`;
        document.getElementById('res-user').innerText = `üé£ ${user}`;
        document.getElementById('res-fish').innerText = fish.name;
        document.getElementById('res-fish').style.color = getRarityColor(fish.rarity);
        document.getElementById('res-detail').innerText = `${'‚òÖ'.repeat(fish.rarity)} | ${size}cm`;
        ui.style.display = 'block';
    }

    function getRarityColor(r) {
        return ["#fff", "#fff", "#4f4", "#44f", "#fa0", "#f0f"][r];
    }

    function hideResultUI() {
        document.getElementById('result-ui').style.display = 'none';
        isPlaying = false;
        processQueue();
    }

    function showRanking() {
        const rankDiv = document.getElementById('ranking');
        const sorted = Object.entries(scores).sort((a, b) => b[1] - a[1]).slice(0, 10);
        rankDiv.innerHTML = "<h2>üèÜ TOP ANGLERS</h2>" + sorted.map(([n, p], i) => `<div>${i+1}. ${n} - ${p}pt</div>`).join('');
        rankDiv.style.bottom = '120%';
        setTimeout(() => { rankDiv.style.bottom = '-100%'; }, 13000);
    }
</script>
</body>
</html>