<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Twitch Fishing Game - Center Result</title>
    <script src="https://cdn.jsdelivr.net/npm/comfy.js@latest/dist/comfy.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: transparent; font-family: 'Helvetica Neue', Arial, sans-serif; }
        #game-container { position: relative; width: 100vw; height: 100vh; }
        #canvas { width: 100%; height: 100%; image-rendering: pixelated; }
        
        /* „Éá„Éê„ÉÉ„Ç∞„Éë„Éç„É´ */
        #debug-panel {
            position: absolute; top: 10px; left: 10px;
            background: rgba(0, 0, 0, 0.8); color: #0f0;
            padding: 15px; font-family: monospace; font-size: 12px;
            display: none; border-radius: 5px; border: 1px solid #0f0; z-index: 10000;
        }

        /* „É™„Ç∂„É´„ÉàË°®Á§∫Ôºà‰∏≠Â§Æ„ÉªÂçäÈÄèÊòéËÉåÊôØÔºâ */
        #result-ui {
            position: absolute; 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%);
            text-align: center; color: white;
            display: none; pointer-events: none; width: auto;
            min-width: 400px;
            padding: 40px;
            background: rgba(0, 0, 0, 0.7); /* ÂçäÈÄèÊòéËÉåÊôØ */
            border-radius: 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            z-index: 50;
        }

        #res-fish { font-size: 4rem; margin: 20px 0; font-weight: bold; }
        
        /* „É¨„Ç¢Â∫¶Âà•„Ç´„É©„Éº */
        .rarity-1 { color: #ffffff; text-shadow: 0 0 10px #aaa; }
        .rarity-2 { color: #44ff44; text-shadow: 0 0 10px #2a2; }
        .rarity-3 { color: #4444ff; text-shadow: 0 0 10px #22a; }
        .rarity-4 { color: #ffee44; text-shadow: 0 0 15px #aa0; }
        .rarity-5 { color: #ff44ff; animation: flash 0.5s infinite; text-shadow: 0 0 20px #a0a; }

        @keyframes flash { 
            0% { transform: scale(1); filter: brightness(1); } 
            50% { transform: scale(1.05); filter: brightness(1.3); } 
        }

        /* „É©„É≥„Ç≠„É≥„Ç∞ */
        #ranking {
            position: absolute; bottom: -100%; left: 50%; transform: translateX(-50%);
            width: 350px; color: gold; text-align: center;
            background: rgba(0,0,0,0.8); padding: 30px; border-radius: 20px;
            border: 1px solid gold;
            transition: bottom 12s linear;
            z-index: 100;
        }
        .rank-item { font-size: 1.5rem; margin: 10px 0; font-weight: bold; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="debug-panel">
        <strong>DEBUG MODE</strong><hr>
        <div>Channel: <span id="db-channel">-</span></div>
        <div>JSON: <span id="db-json">-</span></div>
        <div>Queue: <span id="db-queue">0</span></div>
        <div>Log: <span id="db-log">-</span></div>
    </div>

    <canvas id="canvas"></canvas>
    
    <div id="result-ui">
        <div id="res-user" style="font-size: 1.8rem; color: #ddd; border-bottom: 1px solid #555; padding-bottom: 10px;"></div>
        <div id="res-fish"></div>
        <div id="res-detail" style="font-size: 1.5rem; color: #fff;"></div>
    </div>

    <div id="ranking"></div>
</div>

<script>
    const params = new URLSearchParams(window.location.search);
    const channel = params.get('channel');
    const isDebug = params.get('debug') === '1';

    if (isDebug) document.getElementById('debug-panel').style.display = 'block';

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let fishData = [];
    let queue = [];
    let isPlaying = false;
    let scores = JSON.parse(localStorage.getItem('fishScores') || '{}');

    function log(msg) {
        if (isDebug) document.getElementById('db-log').innerText = msg;
    }

    // „Éâ„ÉÉ„ÉàÁµµÊèèÁîª
    function drawFishPixel(ctx, x, y, size, rarity) {
        const p = size / 16;
        const color = rarity === 5 ? '#ff00ff' : (rarity === 4 ? '#ffd700' : (rarity === 3 ? '#5555ff' : '#888888'));
        
        ctx.fillStyle = color;
        ctx.fillRect(x + 4*p, y + 5*p, 8*p, 6*p); // ‰Ωì
        ctx.fillRect(x + 1*p, y + 4*p, 3*p, 8*p); // Â∞æ
        ctx.fillStyle = 'white';
        ctx.fillRect(x + 10*p, y + 6*p, 2*p, 2*p); // ÁõÆ
        ctx.fillStyle = 'black';
        ctx.fillRect(x + 11*p, y + 7*p, 1*p, 1*p);
    }

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    fetch('fish_data.json')
        .then(res => res.json())
        .then(data => {
            fishData = data;
            if (isDebug) document.getElementById('db-json').innerText = `OK (${data.length})`;
        });

    if (channel) {
        if (isDebug) document.getElementById('db-channel').innerText = channel;
        ComfyJS.onCommand = (user, command) => {
            if (command === "fish") {
                if (queue.some(q => q.user === user)) return;
                queue.push({ user });
                if (isDebug) document.getElementById('db-queue').innerText = queue.length;
                if (!isPlaying) processQueue();
            }
            if (command === "score") showRanking();
        };
        ComfyJS.Init(channel);
    }

    function processQueue() {
        if (isPlaying || queue.length === 0) return;
        isPlaying = true;
        const current = queue.shift();
        if (isDebug) document.getElementById('db-queue').innerText = queue.length;
        startFishingAnimation(current.user);
    }

    function startFishingAnimation(username) {
        const fish = fishData[Math.floor(Math.random() * fishData.length)];
        const sizeScale = 0.8 + Math.random() * 0.6;
        const finalSize = (fish.base_size_cm * sizeScale).toFixed(1);
        const score = Math.floor(fish.rarity * finalSize);

        scores[username] = (scores[username] || 0) + score;
        localStorage.setItem('fishScores', JSON.stringify(scores));

        let frame = 0;
        const phase1 = 40;  // Á≥∏„Çí‰∏ã„Çç„Åô
        const phase2 = 70;  // „Éí„ÉÉ„Éà„ÉªÂºï„Åç‰∏ä„Åí
        const phase3 = 100; // ‰∏≠Â§Æ„Å∏ÁßªÂãï
        const totalFrames = 300; // ÂÖ®‰Ωì„ÅÆÈï∑„Åï

        function frameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            frame++;

            let hookX = canvas.width / 2;
            let hookY;
            let currentFishSize = 40 * (fish.base_size_cm / 50 + 0.5);

            if (frame < phase1) {
                // 1. Á≥∏„Çí‰∏ã„Çç„Åô
                hookY = (frame / phase1) * (canvas.height * 0.6);
            } else if (frame < phase2) {
                // 2. Âºï„Åç‰∏ä„ÅíÈñãÂßã
                hookY = (canvas.height * 0.6) - (frame - phase1) * 15;
            } else if (frame < phase3) {
                // 3. ÁîªÈù¢‰∏≠Â§Æ„Å∏
                let targetY = canvas.height / 2;
                let startY = (canvas.height * 0.6) - (phase2 - phase1) * 15;
                let progress = (frame - phase2) / (phase3 - phase2);
                hookY = startY + (targetY - startY) * progress;
            } else {
                // 4. ‰∏≠Â§Æ„ÅßÈùôÊ≠¢ÔºàÂ∞ë„ÅóÊè∫„Çå„ÇãÊºîÂá∫Ôºâ
                hookY = canvas.height / 2 + Math.sin(frame * 0.1) * 5;
            }

            // Èá£„ÇäÁ≥∏„ÅÆÊèèÁîªÔºàÂºï„Åç‰∏ä„ÅíÂÆå‰∫Ü„Åæ„ÅßÔºâ
            if (frame < phase3) {
                ctx.beginPath();
                ctx.strokeStyle = "#fff";
                ctx.lineWidth = 2;
                ctx.moveTo(hookX, 0);
                ctx.lineTo(hookX, hookY);
                ctx.stroke();
            }

            // È≠ö„ÅÆÊèèÁîª
            if (frame >= phase1) {
                // „É™„Ç∂„É´„Éà‰∏≠„ÅØÂ∞ë„ÅóÂ§ß„Åç„ÅèË°®Á§∫
                const displaySize = (frame > phase2) ? currentFishSize * 1.5 : currentFishSize;
                drawFishPixel(ctx, hookX - displaySize / 2, hookY - displaySize / 2, displaySize, fish.rarity);
            }

            // „É™„Ç∂„É´„ÉàË°®Á§∫„ÅÆ„Çø„Ç§„Éü„É≥„Ç∞
            if (frame === phase3) {
                showResultUI(username, fish, finalSize);
            }

            if (frame < totalFrames) {
                requestAnimationFrame(frameLoop);
            } else {
                hideResultUI();
            }
        }
        frameLoop();
    }

    function showResultUI(user, fish, size) {
        const ui = document.getElementById('result-ui');
        document.getElementById('res-user').innerText = `üé£ ${user}`;
        document.getElementById('res-fish').innerText = fish.name;
        document.getElementById('res-fish').className = `rarity-${fish.rarity}`;
        document.getElementById('res-detail').innerText = `„É¨„Ç¢Â∫¶: ${'‚òÖ'.repeat(fish.rarity)} | „Çµ„Ç§„Ç∫: ${size}cm`;
        ui.style.display = 'block';
    }

    function hideResultUI() {
        document.getElementById('result-ui').style.display = 'none';
        isPlaying = false;
        processQueue();
    }

    function showRanking() {
        const rankDiv = document.getElementById('ranking');
        const sorted = Object.entries(scores).sort((a, b) => b[1] - a[1]).slice(0, 10);
        rankDiv.innerHTML = "<h2 style='color:gold; border-bottom: 2px solid gold;'>üèÜ RANKING</h2>" + 
            sorted.map(([name, pts], i) => `<div class="rank-item">${i+1}. ${name} - ${pts} pt</div>`).join('');
        rankDiv.style.bottom = '120%';
        setTimeout(() => { rankDiv.style.bottom = '-100%'; }, 13000);
    }
</script>
</body>
</html>