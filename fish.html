<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Twitch Fishing Game - Final Polish</title>
    <script src="https://cdn.jsdelivr.net/npm/comfy.js@latest/dist/comfy.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: transparent; font-family: 'Helvetica Neue', Arial, sans-serif; }
        #game-container { position: relative; width: 100vw; height: 100vh; }
        #canvas { width: 100%; height: 100%; image-rendering: pixelated; z-index: 10; position: absolute; top: 0; left: 0; pointer-events: none; }
        
        /* „É™„Ç∂„É´„ÉàUIÂÖ®‰Ωì„ÅÆ„Ç≥„É≥„ÉÜ„Éä */
        #result-wrapper {
            position: absolute; 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%);
            display: none;
            z-index: 20;
            transition: transform 0.8s ease-in; /* Âºï„Åç‰∏ä„ÅíÁî® */
        }

        #result-ui {
            text-align: center; color: white;
            min-width: 500px;
            padding: 50px;
            background: rgba(0, 0, 0, 0.85);
            border-radius: 40px;
            position: relative;
        }

        /* ÊñáÂ≠óÂàó„ÅÆ„Çπ„Çø„Ç§„É´ÔºàÈ≠ö„Çà„ÇäÊâãÂâç„Å´Ë°®Á§∫Ôºâ */
        .res-text { position: relative; z-index: 30; text-shadow: 2px 2px 4px #000; }
        #res-user { font-size: 1.8rem; margin-bottom: 150px; color: #aaa; } /* È≠ö„ÅÆ„Åü„ÇÅ„ÅÆ„Çπ„Éö„Éº„Çπ„ÇíÁ¢∫‰øù */
        #res-rarity { font-size: 1.5rem; margin-bottom: 10px; }
        #res-fish-name { font-size: 4rem; font-weight: bold; margin-bottom: 10px; }
        #res-size { font-size: 2rem; }

        /* „É¨„Ç¢Â∫¶Âà•„Çπ„Çø„Ç§„É´ */
        .rarity-border-1 { border: 4px solid #888; box-shadow: 0 0 20px rgba(136,136,136,0.5); }
        .rarity-border-2 { border: 4px solid #4a4; box-shadow: 0 0 20px rgba(68,255,68,0.5); }
        .rarity-border-3 { border: 4px solid #44f; box-shadow: 0 0 25px rgba(68,68,255,0.6); }
        .rarity-border-4 { border: 4px solid #ea0; box-shadow: 0 0 35px rgba(238,170,0,0.7); }
        .rarity-border-5 { border: 4px solid #f0f; box-shadow: 0 0 50px rgba(255,0,255,0.8); animation: glow-pulse 1s infinite alternate; }

        @keyframes glow-pulse { from { transform: scale(1); } to { transform: scale(1.03); } }

        #ranking {
            position: absolute; bottom: -100%; left: 50%; transform: translateX(-50%);
            width: 350px; color: gold; text-align: center;
            background: rgba(0,0,0,0.9); padding: 30px; border-radius: 20px;
            border: 2px solid gold; transition: bottom 12s linear; z-index: 100;
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="canvas"></canvas>
    
    <div id="result-wrapper">
        <div id="result-ui">
            <div id="res-user" class="res-text"></div>
            <div id="res-rarity" class="res-text"></div>
            <div id="res-fish-name" class="res-text"></div>
            <div id="res-size" class="res-text"></div>
        </div>
    </div>

    <div id="ranking"></div>
</div>

<script>
    const params = new URLSearchParams(window.location.search);
    const channel = params.get('channel');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    let fishData = [];
    let queue = [];
    let isPlaying = false;
    let scores = JSON.parse(localStorage.getItem('fishScores') || '{}');

    // ÁèæÂú®„ÅÆÊºîÂá∫Áî®Â§âÊï∞
    let currentFish = null;
    let currentHookY = 0;
    let currentHue = 0;
    let animFrame = 0;
    let animPhase = ""; // "fishing", "result", "exit"

    function drawProceduralObject(ctx, x, y, size, hue, fishId, category) {
        const p = size / 16;
        ctx.fillStyle = `hsl(${hue}, 60%, 50%)`;
        if (category === "trash" || category === "treasure") {
            ctx.fillRect(x + 3*p, y + 4*p, 10*p, 8*p);
        } else {
            const bodyType = fishId % 3; const tailType = (fishId >> 2) % 3;
            ctx.fillStyle = `hsl(${hue}, 60%, 40%)`;
            if (tailType === 0) ctx.fillRect(x + 1*p, y + 4*p, 3*p, 8*p);
            else ctx.fillRect(x + 2*p, y + 5*p, 2*p, 6*p);
            ctx.fillStyle = `hsl(${hue}, 60%, 50%)`;
            if (bodyType === 1) ctx.fillRect(x + 4*p, y + 7*p, 11*p, 3*p);
            else ctx.fillRect(x + 4*p, y + 5*p, 9*p, 6*p);
            ctx.fillStyle = 'white'; ctx.fillRect(x + 10*p, y + 6*p, 2*p, 2*p);
        }
    }

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize);
    resize();

    fetch('fish_data.json').then(res => res.json()).then(data => { fishData = data; });

    if (channel) {
        ComfyJS.onCommand = (user, command) => {
            if (command === "fish" && !queue.some(q => q.user === user)) {
                queue.push({ user });
                if (!isPlaying) processQueue();
            }
            if (command === "score") showRanking();
        };
        ComfyJS.Init(channel);
    }

    function processQueue() {
        if (isPlaying || queue.length === 0) return;
        isPlaying = true;
        startFishing(queue.shift().user);
    }

    function startFishing(username) {
        currentFish = fishData[Math.floor(Math.random() * fishData.length)];
        const sizeScale = 0.8 + Math.random() * 0.6;
        const finalSize = (currentFish.base_size_cm * sizeScale).toFixed(1);
        currentHue = Math.floor(Math.random() * 360);
        scores[username] = (scores[username] || 0) + Math.floor(currentFish.rarity * finalSize);
        localStorage.setItem('fishScores', JSON.stringify(scores));

        animFrame = 0;
        animPhase = "fishing";
        const wrapper = document.getElementById('result-wrapper');
        wrapper.style.display = 'none';
        wrapper.style.transform = 'translate(-50%, -50%)'; // ‰ΩçÁΩÆ„É™„Çª„ÉÉ„Éà

        function loop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            animFrame++;

            const p1 = 50, p2 = 130, p3 = 180;
            const fishBaseSize = 40 * (currentFish.base_size_cm / 50 + 0.5);

            if (animPhase === "fishing") {
                if (animFrame < p1) currentHookY = (animFrame / p1) * (canvas.height * 0.6);
                else if (animFrame < p2) currentHookY = (canvas.height * 0.6) - (animFrame - p1) * 5;
                else if (animFrame < p3) {
                    let targetY = canvas.height / 2;
                    let startY = (canvas.height * 0.6) - (p2 - p1) * 5;
                    currentHookY = startY + (targetY - startY) * ((animFrame - p2)/(p3 - p2));
                } else {
                    animPhase = "result";
                    showResultUI(username, currentFish, finalSize);
                    setTimeout(() => { animPhase = "exit"; }, 5000); // 5ÁßíË°®Á§∫
                }

                // Á≥∏„ÅÆÊèèÁîª
                if (animFrame < p3) {
                    ctx.strokeStyle = "white"; ctx.lineWidth = 2;
                    ctx.beginPath(); ctx.moveTo(canvas.width/2, 0); ctx.lineTo(canvas.width/2, currentHookY); ctx.stroke();
                }
                // È≠ö„ÅÆÊèèÁîª
                if (animFrame >= p1) {
                    const dSize = (animFrame > p2) ? fishBaseSize * 2.5 : fishBaseSize;
                    drawProceduralObject(ctx, canvas.width/2 - dSize/2, currentHookY - dSize/2, dSize, currentHue, currentFish.id, currentFish.category);
                }
                requestAnimationFrame(loop);

            } else if (animPhase === "result") {
                // ‰∏≠Â§Æ„Åß„Åµ„Çè„Åµ„Çè
                currentHookY = canvas.height / 2 + Math.sin(animFrame * 0.05) * 8;
                const dSize = fishBaseSize * 2.5;
                drawProceduralObject(ctx, canvas.width/2 - dSize/2, currentHookY - dSize/2, dSize, currentHue, currentFish.id, currentFish.category);
                requestAnimationFrame(loop);

            } else if (animPhase === "exit") {
                // ‰∏ä„Å´Âºï„Åç‰∏ä„Åí
                currentHookY -= 20;
                wrapper.style.transform = `translate(-50%, ${-50 + (currentHookY - canvas.height/2) / 10}%)`; // „Éë„Éç„É´„ÇÇÈÄ£Âãï
                
                const dSize = fishBaseSize * 2.5;
                drawProceduralObject(ctx, canvas.width/2 - dSize/2, currentHookY - dSize/2, dSize, currentHue, currentFish.id, currentFish.category);

                if (currentHookY + 200 > 0) {
                    requestAnimationFrame(loop);
                } else {
                    wrapper.style.display = 'none';
                    isPlaying = false;
                    processQueue();
                }
            }
        }
        loop();
    }

    function showResultUI(user, fish, size) {
        const wrapper = document.getElementById('result-wrapper');
        const ui = document.getElementById('result-ui');
        ui.className = `rarity-border-${fish.rarity}`;
        
        document.getElementById('res-user').innerText = `üé£ ${user}`;
        document.getElementById('res-rarity').innerText = '‚òÖ'.repeat(fish.rarity);
        document.getElementById('res-rarity').style.color = getRarityColor(fish.rarity);
        document.getElementById('res-fish-name').innerText = fish.name;
        document.getElementById('res-size').innerText = `${size} cm`;
        
        wrapper.style.display = 'block';
    }

    function getRarityColor(r) { return ["", "#fff", "#4f4", "#44f", "#ea0", "#f0f"][r]; }

    function showRanking() {
        const rankDiv = document.getElementById('ranking');
        const sorted = Object.entries(scores).sort((a, b) => b[1] - a[1]).slice(0, 10);
        rankDiv.innerHTML = "<h2>üèÜ TOP ANGLERS</h2>" + sorted.map(([n, p], i) => `<div>${i+1}. ${n} - ${p}pt</div>`).join('');
        rankDiv.style.bottom = '120%';
        setTimeout(() => { rankDiv.style.bottom = '-100%'; }, 13000);
    }
</script>
</body>
</html>